<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ElectroCare Assistant</title>
  <style>
    :root { --bg:#0b1023; --panel:#0f172a; --bot:#1f2937; --user:#2563eb; --text:#e5e7eb; --muted:#9ca3af; --accent:#22c55e; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:500px;margin:0 auto;min-height:100vh;padding:20px;display:flex;align-items:center;justify-content:center}
    .panel{width:100%;background:rgba(15,23,42,.92);border:1px solid rgba(255,255,255,.06);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35);backdrop-filter:blur(6px);display:flex;flex-direction:column;overflow:hidden}
    .hdr{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.06);background: linear-gradient(90deg, #3b82f6, #9333ea);}
    .left{display:flex;gap:12px;align-items:center}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 10px var(--accent)}
    .title{font-weight:700}
    .sub{color:var(--muted);font-size:13px}
    .lang{display:flex;gap:6px;align-items:center}
    .lang select{padding:6px 8px;border-radius:8px;background:rgba(1, 1, 3, 0.12);border:1px solid rgba(255,255,255,.25);color:#fff}
    .chat{height:45vh;overflow-y:auto;padding:18px;display:flex;flex-direction:column;gap:12px}
    .row{display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:flex-end}
    .row.user{grid-template-columns:1fr auto}
    .row.user .bubble{justify-self:end}
    .row.user .avatar{order:2}
    .row.noicon{grid-template-columns:1fr}
    .bubble{max-width:100%;padding:12px 14px;border-radius:16px;white-space:pre-wrap;line-height:1.35}
    .bubble.bot{background:rgba(31,41,55,.88);border:1px solid rgba(255,255,255,.06);border-bottom-left-radius:6px}
    .bubble.user{background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;border-bottom-right-radius:6px}
    .avatar{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08)}
    .avatar svg{width:16px;height:16px;opacity:.85}
    .avatar.user{background:rgba(59,130,246,.18);border-color:rgba(59,130,246,.35)}
    .meta{grid-column:2/3;margin-top:4px;display:flex;gap:8px}
    .badge{font-size:11px;color:#d1fae5;background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.25);padding:3px 6px;border-radius:8px}
    .badge.warn{color:#fde68a;border-color:rgba(251,191,36,.35);background:rgba(251,191,36,.08)}
    .badge.gray{color:#cbd5e1;border-color:rgba(148,163,184,.35);background:rgba(148,163,184,.08)}
    .typing{display:inline-flex;gap:4px;padding:10px 12px;background:rgba(31,41,55,.88);border:1px solid rgba(255,255,255,.06);border-radius:14px}
    .typing span{width:6px;height:6px;background:#9ca3af;border-radius:50%;animation:blink 1.2s infinite ease-in-out}
    .typing span:nth-child(2){animation-delay:.15s}.typing span:nth-child(3){animation-delay:.3s}
    @keyframes blink{0%,80%,100%{opacity:.25;transform:translateY(0)}40%{opacity:1;transform:translateY(-3px)}}
    .composer{display:flex;gap:10px;padding:12px 14px;border-top:1px solid rgba(255,255,255,.06);background:linear-gradient(0deg,rgba(255,255,255,.03),transparent)}
    .composer input{flex:1;padding:13px 14px;background:rgba(17,24,39,.6);color:var(--text);border:1px solid rgba(255,255,255,.08);border-radius:12px;outline:none}
    .composer button{padding:12px 16px;background:linear-gradient(135deg,#06b6d4,#3b82f6);color:#fff;border:none;border-radius:12px;font-weight:600;cursor:pointer}
    .composer button:disabled{opacity:.6;cursor:not-allowed}
    .hint{text-align:center;color:#a3a3a3;font-size:12px;padding:8px}
    a{color:#93c5fd}
    .chip{margin:4px 6px 0 0;padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:transparent;color:#e5e7eb;cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="hdr">
        <div class="left">
          <div class="dot"></div>
          <div>
            <div class="title">ElectroCare Assistant</div>
            <div class="sub">Ask about services, policies, steps, and where to find things.</div>
          </div>
        </div>
        <div class="lang">
          <label for="lang" style="font-size:12px;color:#e5e7eb;opacity:.8">Language</label>
          <select id="lang">
            <option value="en" selected>English</option>
            <option value="it">Italiano</option>
            <option value="ti">Tigrigna</option>
          </select>
        </div>
      </div>

      <main id="chat" class="chat" aria-live="polite"></main>

      <div class="composer">
        <div class="avatar user" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.2 0-8 2.1-8 5v1h16v-1c0-2.9-3.8-5-8-5Z"/></svg>
        </div>
        <input id="msg" placeholder='Type your question… (e.g., "how do I start a return?")' />
        <button id="send">Send</button>
      </div>

      <div class="hint">Tip: press <strong>Enter</strong> to send • </div>
    </div>
  </div>

  <script>
    const chat = document.getElementById('chat');
    const input = document.getElementById('msg');
    const sendBtn = document.getElementById('send');
    const langSel = document.getElementById('lang');
    const API = '/chat';

    const botIcon = `
      <div class="avatar" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a2 2 0 0 0-2 2v1H8a3 3 0 0 0-3 3v7a3 3 0 0 0 3 3h8a3 3 0 0 0 3-3V8a3 3 0 0 0-3-3h-2V4a2 2 0 0 0-2-2Z"/></svg>
      </div>`;

    const userIcon = `
      <div class="avatar user" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.2 0-8 2.1-8 5v1h16v-1c0-2.9-3.8-5-8-5Z"/></svg>
      </div>`;

    function addBubble(text, who='bot', meta={}) {
      const row = document.createElement('div');
      row.className = `row ${who}`;
      row.innerHTML = `
        ${who==='user' ? '' : botIcon}
        <div class="bubble ${who}"></div>
        ${who==='user' ? userIcon : ''}`;
      row.querySelector('.bubble').textContent = text;
      chat.appendChild(row);

      const DEBUG_UI = new URLSearchParams(location.search).get('debug') === '1';
      if (DEBUG_UI && who === 'bot' && (meta.intent || meta.confidence != null || meta.routed_to)) {
        const m = document.createElement('div'); m.className='meta';
        if (meta.routed_to) { const b=document.createElement('span'); b.className='badge gray'; b.textContent=meta.routed_to; m.appendChild(b); }
        if (meta.intent)    { const b=document.createElement('span'); b.className='badge'; b.textContent=meta.intent; m.appendChild(b); }
        if (typeof meta.confidence === 'number') {
          const b=document.createElement('span'); b.className=(meta.confidence<0.6?'badge warn':'badge');
          b.textContent=`conf ${meta.confidence.toFixed(2)}`; m.appendChild(b);
        }
        row.appendChild(m);
      }
      chat.scrollTop = chat.scrollHeight;
    }

    function addTyping() {
      const row = document.createElement('div');
      row.className = 'row'; row.id = 'typing';
      row.innerHTML = `${botIcon}<div class="typing"><span></span><span></span><span></span></div>`;
      chat.appendChild(row); chat.scrollTop = chat.scrollHeight;
    }
    function removeTyping(){ const t = document.getElementById('typing'); if (t) t.remove(); }

    async function send() {
      const text = input.value.trim();
      if (!text) return;
      addBubble(text, 'user');
      input.value = ''; input.focus(); sendBtn.disabled = true; addTyping();

      try {
        const res = await fetch(API, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({message:text, lang: langSel.value})
        });
        const data = await res.json();
        removeTyping();

        const answer = data.reply || data.answer || data.text || '…';
        addBubble(answer, 'bot', data.meta || {});

        if (Array.isArray(data.links) && data.links.length) {
          const row = document.createElement('div');
          row.className = 'row noicon';
          row.innerHTML = `<div class="bubble bot"></div>`;
          row.querySelector('.bubble').innerHTML =
            data.links.map(x=>`• <a href="${x.url}" target="_blank" rel="noreferrer">${x.title||x.url}</a>`).join('<br>');
          chat.appendChild(row);
        }

        if (Array.isArray(data.suggestions) && data.suggestions.length) {
          const row = document.createElement('div');
          row.className = 'row noicon';
          row.innerHTML = `<div class="bubble bot"></div>`;
          const box = row.querySelector('.bubble');
          box.innerHTML = data.suggestions.map(x=>`<button class="chip">${x}</button>`).join('');
          box.querySelectorAll('button').forEach(b=>b.addEventListener('click', ()=>{ input.value = b.textContent; send(); }));
          chat.appendChild(row);
        }

        chat.scrollTop = chat.scrollHeight;
      } catch (e) {
        removeTyping();
        addBubble('Sorry—something went wrong connecting to the server.', 'bot', {routed_to:'error'});
      } finally {
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener('click', send);
    input.addEventListener('keydown', e => { if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); } });

    addBubble("Hi! I’m the ElectroCare assistant.\nAsk me about services, returns, payments, or where things are on the site.");
  </script>
</body>
</html>
